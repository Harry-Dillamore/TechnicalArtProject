# Advanced Material Systems - Harry Dillamore

## Stylized Water Material with World Position Offset

| **Requirement** | **Description / Implementation** | **Evidence** |
| --- | --- | --- |
| **World Position Offset**     | The world position offset is used to deform the vertices of an object , this can be used for the water to create waves on the surface. In the material graph, I implemented the WPO effect by using panning textures which use the `texCoord` and an adjustable `scale` parameter as input to the textures' UVs to move across the the material. I have used two textures so there is some distortion on a macro scale using a noise texture and a waves on a larger scale using a wave texture. I have allowed adjustment using the parameters for scale, speed, and size for each the large waves and the small waves. These parameters adjust: the scale of the texture used for WPO, the speed at which the texture is panned, and the size - in height - of the waves. WPO is much cheaper than using a skeletal mesh, but the cost on performance increases with the vertex density of the mesh. I have used a mesh with many vertices for the smoothest effect, but less complex geometry would be appropriate for a larger scale application but would lead to sharper and more 'blocky' waves. | <img alt="Wireframe view of water" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251031-1704-21.4433165.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 1 - Wireframe view of water* <br> <img alt="WPO water material graph" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-6.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 2 - Material graph (WPO water)* |
| **Visual Elements - Foam**    | Foam is generated dynamically based on proximity to objects in the water. The implementation relies on the `DistanceToNearestSurface` node, which calculates how far any pixel on the water's surface is from any other geometry. This distance is used to create a "distance field," allowing the `FoamDist` parameter to control how far the foam extends from an edge. To create the foam's rippling appearance, a wave is generated using `Time` and a `Sine` node. The effect is adjusted by the `FoamSpeed` and `FoamLines` parameters which allow more customisation of the speed and size of the foam waves. Finally, panning noise textures are used - one micro and one macro - which break up the lines for a more natural appearance. | <img alt="Demo of cube affecting foam" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251031-2100-32.1047222.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 3 - Demo of cube affecting foam* <br> <img alt="Material graph for foam" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-7.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 4 - Material graph for foam* |
| **Visual Elements - Normals** | The normal maps define how light interacts with the surface of the water and allows light to reflect in varied directions as would be seen in real life. To add fine, high - frequency detail to the water surface, I have used two separate normal maps which simulate small waves and distortion on the surface of the water. I use the `blendAngleCorrectedNormals` node to combine the two normal map textures. The direction that the normal maps pan in is controlled by `windDirection` and the speed of the panning is controlled by `wind`. These are MPC parameters which can be changed by the user or in blueprints during runtime. The direction is normalised and multiplied by the wind amount, then used for the panning of each normal map | <img alt="Demo of wind speed and direction 1" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251031-2151-57.2325389.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 5 - Demo of wind speed and direction 1* <br> <img alt="Demo of wind speed and direction 2" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251031-2155-03.4017996.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 6 - Demo of wind speed and direction 2* <br> <img alt="Normal map material Graph" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-8.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 7 - Normal map material Graph* <br> <img alt="Final Water Material" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251031-1655-53.5006650.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 8 - Final water material* |

## Material Parameter Collection

| **Requirement**| **Description / Implementation** | **Evidence**|
| --- | --- | --- |
| **MPC Parameters** | I created an MPC with a variety of parameters that would let me control weather effects in the level, the MPC gives a central location to manage theses effects and  means I can use singular parameters to affect as many materials as needed. If I was working in a team, I could also see how this makes it very easy for other people such as artists to tweak the look of the world. | <img alt="MPC scalar parameters" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-9.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 9 - MPC scalar parameters* <br> <img alt="MPC vector parameters" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-10.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 10 - MPC vector parameters*|
| **Modification during runtime** | I created a weather cycle blueprint that changes the weather effects smoothly based on a custom float curve and `CycleDurationSeconds` I also wanted the water to be smoothly adjusted based on `wind` and `windDirection` but I found that the `panner` node caused jumping during the transition, from what I found this is because it calculates the pan amount using $panSpeed \times gameTime$. Because the game time is always a high number any changes to the pan speed result in a big visual jump. To fix this I instead calculate what the difference in each frame of the pan should be, meaning that there are no jumps when the speed is changed. | <img alt="Demo of MPC parameters being altered during runtime" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251103-2049-03.3980113.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 11 - Demo of MPC parameters being changed during runtime* <br> <img alt="BP for defining texture panning speed" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-11.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 12 - BP for Defining texture panning speed* <br> <img alt="BP for settings MPC values based on weather cycle" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-12.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 13 - BP for setting MPC values based on weather cycle* |
| **Material Implementation and Consistency** | The MPC's parameters are used across multiple materials to create a cohesive environmental effect. For example the `wetness` parameter is used with a material function to decrease the ground's roughness and it's brightness. This process could be easily replicated in any materials that are exposed to the weather. It is also used to `LERP` the ground normals in order to add puddles when the ground is wet. At the same time, the `stormyness` parameter is used to change the colour of the water and increase the `storm clouds` parameter of the volumetric cloud material. In addition the `RainAmount`, `WindDirection` and `Wind` are used to drive the relative parts of the rain particle system as well as the direction and speed of waves on the water surface and the speed of puddles on the ground. <br> This guarantees visual consistency because all environmental elements are driven by the same source. MPCs are also more performant than updating many individual material instances, because the the engine is able to batch all MPC changes into one efficient update for the GPU. | <img alt="Landscape material graph MPC usage (1)" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-13.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 14 - Landscape material graph MPC usage (1)* <br> *Figure* <br> <img alt="Landscape material graph MPC usage (2)" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-14.png"> <br> *Figure 15 - Landscape material graph MPC usage (1)* <br> <img alt="BP for updating rain system using MPC" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-15.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 16 - BP for updating rain system using MPC* <br> <img alt="BP for updating cloud material fog density using MPC" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-16.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 17 - BP for updating cloud material fog density using MPC* |

## Parallax Occlusion Mapping (POM) Material

| **Requirement**| **Description / Implementation** | **Evidence**|
| --- | --- | --- |
| **POM Implementation** | POM is used to fake 3D detail on a flat surface. It is able to create a much more convincing 3D effect compared to normal maps and similar. It does this by using raymarching across the texture to find the visible depth of each pixel, this allows self shadowing and parallax effects to function. For example, parts of the texture that are high up occlude the lower points behind them. In the material graph I use the `ParallaxOcclusionMapping` inputting the heightmap of the texture I am using and the `TexCoord` node - the parallax UV output is then used to go into the UV input of each texture used. I have made parameters for most of the other inputs to the `ParallaxOcclusionMapping` to allow customisation of the level of detail of the effect.  | <img alt="POM material Vs regular material" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-17.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 18 - POM material compared to POM material*  <br> <img alt="POM material Graph" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-18.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 19 - POM material graph* |
| **Quality Performance and Limitations** | A balance has to be found when using POM as it is much more demanding than a regular material. This is because each pixel has to be processed multiple times, whereas a normal texture only checks once, The level of detail is mainly controlled by the `MinSteps` and `MaxSteps` the number of steps refers to how many checks are done to find the correct depth of each pixel. Each check essentially sees if the raymarch has hit the surface yet. the effect is very convincing when viewed from the front and used on flat surfaces. However, the silhouette of the geometry remains a hard edge, meaning that if the object has the edges visible, it can look broken and much less effective. | <img alt="POM quality adjustment" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251107-1038-44.5581891.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 20 - POM quality adjustment* <br> <img alt="POM viewing angles" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251107-1040-33.6683877.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 21 - POM viewing angles demo* <br> <img alt="POM material" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-37.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 22 - POM material* |

## Cel Shading Effect

| **Requirement**| **Description / Implementation** | **Evidence**|
| --- | --- | --- |
| **Post Process Setup** | Because this is a post process material, it acts as a filter over the scene. To ensure that this happens correctly, the `material domain` is set to `post process` and the `blendable location` is set to `after tonemapping`. <br> The effect is not applied automatically to everything because it works better with some objects compared to others, and being able to customise what is cel shaded allows for a better final look to the scene. To do this, a mask is created by comparing `SceneDepth` with `CustomDepth` so that only objects with `RenderCustomDepthPass` enabled with have the effect applied. | <img alt="Cel Shader graph (1)" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 23 - Cel shader graph (1)* <br> <img alt="Cel Shader graph (2)" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-1.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 24 - Cel shader graph (2)* <br> <img alt="cel Shading on a sphere" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-40.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 25 - Cel shading on a sphere* |
| **Lighting Effect** | The cel shaded look is created by forcing bands of light rather than a smooth gradient. To do this, I take the `SceneTexture:PostProcessInput0` and desaturate it to get only the brightness. I take this value and multiply it by the number of bands wanted, then used the `floor` node to remove and decimal places, and finally divide by the number of bands. I have also made the `CelShadingBands` and `CelShadingMinBrightness` MPC parameters so that they can be adjusted from there. | <img alt="Cel shading light logic" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-38.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 25 - Cel shading light logic* <br> <img alt="Min brightness adjustment" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251107-1129-57.9929057.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 26 - Min brightness adjustment* <br> <img alt="CelShadingBands adjustment" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/20251107-1132-38.1943234.gif" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 27 - CelShadingBands adjustment* |
| **Colour and Composition** | The post process effect functioned correctly but did not support any coloured lighting, meaning that all light was being rendered as white. If this fit the look of the game, it could be left like this as a stylistic choice, but for my scene I wanted the ability to display coloured lighting. I found that the solution was to get normalized value of the final `SceneColour`, add the `CelShadingMinBrightness` (to avoid pure blacks) and multiply this with the black and white shadow bands. This means that there can be gradients of colour within the bands of light. I also found there was an issue with distance fog, where it would not render properly on the cel shaded landscape, To fix this, I added a `LERP` based on distance, to fade out the cel shaded effect far away fom the player. This allowed fog to work as intended and also created more contrast between the foreground and background. I was able to do this using the `sceneDepth` Node which returns the distance from the player to the surface. I then divide this value by the distance that I want the `LERP` to cover and use the `saturate` node to clamp values outside of 0 and 1, this means that I can create a smooth transition over a distance that I input into the divide. | <img alt="distance based cel shader on" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-36.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 28 - distance based cel shading* <br> <img alt="Cel shader with distance lerp graph" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-42.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 29 - Distance based cel shader graph* <br> <img alt="cel shader without distance lerp" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-39.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 30 - Cel shader without distance lerp* <br> <img alt="graph used for cel shader without lerp" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-41.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 31 - cel shader without distance lerp material graph* <br> <img alt="Incorrect Light Colour" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-2.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 32 - Cel shader displaying wrong colours* <br> <img alt="correct Light colour" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-3.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 33 - Cel shader showing correct colour* <br> <img alt="Material graph with colour added" src="https://pub-9c6c59cb1e3f474f938dca895e9f576d.r2.dev/image-43.png" style="cursor: pointer;" onclick="this.requestFullscreen();"> <br> *Figure 34 - Material graph for light with colour*|

## Bibliography

**Aspland, M.** (n.d.) *How To Create Cel-Shading In Unreal Engine 4/5 (Tutorial)*. [Online video]. YouTube.

**CodeLikeMe** (n.d.) *Unreal Engine 5 - Stylized Sea Shader - Foams and Waves*. [Online video]. YouTube.

**Coreb Games** (n.d.) *UE5 l Realistic Textures with Parallax Occlusion Mapping (POM) l Material Tutorial l Unreal Engine 5*. [Online video]. YouTube.

**E., R.** (2023) *Colored Cel Shader*. [Online document and script]. Reddit link provided for timestamp/documentation.

**PrismaticaDev** (n.d.) *Advanced Cel-Shader in UE4 & UE5 [Prismati-Cel Part 1]*. [Online video]. YouTube.

**PrismaticaDev** (n.d.) *Material Parameter Collection | 5-Minute Materials [UE5]*. [Online video]. YouTube.

**TUF** (n.d.) *Animated Rain and Splash Effects | Unreal Engine Tutorial*. [Online video]. YouTube.

### Declared Assets

**Google Gemini 2.5 pro** - Used for writing and adjusting parts of this document and debugging.

**NotebookLM** - Used for getting information from sources.

**Dirt Texture** - Used for POM material <https://fab.com/s/539354ec05b8>